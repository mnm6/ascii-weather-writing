<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ASCII Weather ‚Äî Gentle Floating Words + Print</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
html, body { margin:0; height:100%; background:#111; color:#eee; font-family:monospace; overflow:hidden; }
#map { position:absolute; inset:0; z-index:0; filter:grayscale(100%) brightness(85%) contrast(1.05); }
#sky { position:absolute; inset:0; z-index:5; pointer-events:none; }
/* Panel */
#panel{
  position:absolute; top:12px; left:12px; width:280px; display:flex; flex-direction:column; gap:10px;
  background:rgba(20,20,20,.86); padding:12px; border-radius:14px; backdrop-filter:blur(4px); z-index:1000; font-size:13px;
}
#panel .block{ display:flex; flex-direction:column; gap:6px; }
#panel .row{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
#panel label{ font-size:11px; opacity:.8; letter-spacing:.02em; }
#panel input[type=text], #panel input[type=date], #panel input[type=time]{
  width:100%; box-sizing:border-box; background:#2c2c2c; color:#eee; border:none; padding:6px 8px; border-radius:6px;
}
#word{ background:#3a3a3a !important; box-shadow:inset 0 0 0 1px #666; }
#word:focus{ outline:none; box-shadow:inset 0 0 0 2px #ffcc66, 0 0 0 2px rgba(255,204,102,.25); background:#414141; }
#panel button{ background:#444; color:#eee; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }
#panel button:hover{ background:#666; }
.switch{ display:inline-flex; align-items:center; gap:8px; cursor:pointer; } .switch input{ display:none; }
.toggle{ width:36px; height:18px; background:#555; border-radius:18px; position:relative; transition:background .2s; }
.toggle::after{ content:""; position:absolute; top:2px; left:2px; width:14px; height:14px; border-radius:50%; background:#ddd; transition:left .2s; }
input:checked + .toggle{ background:#3aa163; } input:checked + .toggle::after{ left:20px; }
.spin{ display:inline-block; margin-left:6px; animation:rot 1s linear infinite; opacity:.6; }
@keyframes rot { from{transform:rotate(0)} to{transform:rotate(360deg)} }

/* Barre Print en bas */
#printBar{
  position:absolute; left:12px; bottom:12px; z-index:1001;
  background:rgba(20,20,20,.86); padding:8px 10px; border-radius:10px; backdrop-filter: blur(4px);
}
</style>
</head>
<body>
<div id="map"></div>
<canvas id="sky"></canvas>

<div id="panel">
  <div class="block">
    <label for="word">Word</label>
    <input id="word" type="text" value="„Éª„Éª„Éª" maxlength="24"/>
    <div class="row">
      <button id="regen">Regenerate</button>
      <div class="row" style="margin-left:auto;">
        <button id="zoomIn">+</button>
        <button id="zoomOut">‚àí</button>
      </div>
    </div>
  </div>
  <div class="block">
    <div class="row">
      <div style="flex:1">
        <label>Date</label><input id="date" type="date"/>
      </div>
      <div style="flex:1">
        <label>Hour</label><input id="hour" type="time" value="12:00"/>
      </div>
    </div>
    <div class="row">
      <button id="load">Load Weather</button><span id="loadSpin" class="spin" style="display:none;">‚ü≥</span>
      <button id="warp">Warp weather</button>
      <button id="typhoon">Typhoon</button>
    </div>
    <div class="row">
      <label class="switch" title="Reload weather after each map move">
        <input id="autoWeather" type="checkbox"/><span class="toggle"></span><span>Auto weather on move</span>
      </label>
    </div>
  </div>
  <div class="block" id="data">
    <div>‚òÅÔ∏è Cloud cover: <b><span id="cloudVal">--</span>%</b></div>
    <div>üí® Wind: <b><span id="windVal">--</span> m/s</b> (<span id="windKmh">--</span> km/h) ‚Äî dir <span id="windDirTxt">--</span></div>
    <div>üåß Rain: <b><span id="rainVal">--</span> mm/h</b></div>
    <div id="alerts" style="margin-top:6px;color:#f6efe5;">Alerts: <span id="alertsText">‚Äî</span></div>
  </div>
</div>

<!-- Barre Print -->
<div id="printBar">
  <button id="printBtn">Print</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ---------- Map & Canvas ----------
const map = L.map("map",{zoomControl:false}).setView([48.8566,2.3522],17);
const carto = L.tileLayer("https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png",{attribution:"",opacity:.9}).addTo(map);
carto.on("tileerror",()=>{ L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OSM",opacity:.95}).addTo(map);});
setTimeout(()=>map.invalidateSize(),0);
document.getElementById("zoomIn").onclick=()=>map.zoomIn();
document.getElementById("zoomOut").onclick=()=>map.zoomOut();

const canvas=document.getElementById("sky"); const ctx=canvas.getContext("2d");
canvas.width=innerWidth; canvas.height=innerHeight; canvas.style.pointerEvents="none";
addEventListener("resize",()=>{canvas.width=innerWidth;canvas.height=innerHeight;map.invalidateSize();});

// ---------- Motion tuning ----------
const WORD_SIZE_SCALE = 0.8;
const WIND_DRIFT_BASE = 0.000010;
const WIND_DRIFT_SCALE= 0.18;
const BREATH_AMP      = 0.000004;
const BREATH_FREQ     = 1.0;
const FIXED_WORD_WIDTH= 820;

// ---------- Zoom-based motion boost ----------
function motionZoomBoost(baseZoom = 17) {
  const z = map.getZoom();
  const scale = map.getZoomScale(z, baseZoom); // 2^(z-baseZoom)
  const boost = 1 / scale;                      // => 2^(baseZoom - z)
  return Math.max(1, Math.min(boost, 64));
}

// ---------- State ----------
let clouds=[], wordClouds=[], rainDrops=[], lightningDrops=[], snowFlakes=[];
let windAngle=0, windSpeed=1, cloudCover=50, rainAmount=0, snowAmount=0;
let sun={x:canvas.width/2,y:canvas.height/2,size:40,visible:false}, draggingSun=false;
let typhoonActive=false, typhoonUntil=0;
let autoWeather=false; const autoChk=document.getElementById("autoWeather");
let alertsState={ thunder:false, gale:false, storm:false, typhoon:false, snow:false };

// Historique de mots pour l‚Äôimpression
let wordsHistory = [];

// ---------- Utils ----------
function randomDate(a,b){const t=a.getTime()+Math.random()*(b.getTime()-a.getTime());return new Date(t);}
function degToDirArrow(deg){const d=[{n:"N",c:"‚Üë",a:0},{n:"NE",c:"‚Üó",a:45},{n:"E",c:"‚Üí",a:90},{n:"SE",c:"‚Üò",a:135},{n:"S",c:"‚Üì",a:180},{n:"SW",c:"‚Üô",a:225},{n:"W",c:"‚Üê",a:270},{n:"NW",c:"‚Üñ",a:315}];
 let best=d[0],m=1e9;for(const x of d){const df=Math.min(Math.abs(deg-x.a),360-Math.abs(deg-x.a));if(df<m){m=df;best=x;}}return best;}
function escapeHtml(s){return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}

document.addEventListener("DOMContentLoaded",()=>{const de=document.getElementById("date");if(de&&!de.value){try{const f=new Intl.DateTimeFormat("en-CA",{timeZone:"Europe/Paris",year:"numeric",month:"2-digit",day:"2-digit"});de.value=f.format(new Date());}catch{const d=new Date();de.value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}}
 const he=document.getElementById("hour");if(he&&!he.value){const h=String(new Date().getHours()).padStart(2,"0");he.value=`${h}:00`;}});

// ---------- Background clouds ----------
function createClouds(){clouds=[];const b=map.getBounds();
 for(let i=0;i<1200;i++){const lat=b.getSouth()+Math.random()*(b.getNorth()-b.getSouth());
  const lng=b.getWest()+Math.random()*(b.getEast()-b.getWest());
  clouds.push({lat,lng,alpha:.7+Math.random()*.3});}}
createClouds();

let autoTimer=null;
map.on("moveend",()=>{createClouds(); if(!autoWeather) return; if(autoTimer)clearTimeout(autoTimer); autoTimer=setTimeout(()=>loadWeather(map.getCenter()),350);});
autoChk.addEventListener("change",()=>{autoWeather=autoChk.checked;});

// ---------- Weather (archive) ----------
async function loadWeather(center){
  const c=center||map.getCenter(); const date=document.getElementById("date").value;
  const hour=parseInt(document.getElementById("hour").value.split(":")[0],10);
  const spin=document.getElementById("loadSpin"); if(spin) spin.style.display="inline-block";
  const url=`https://archive-api.open-meteo.com/v1/archive?latitude=${c.lat.toFixed(3)}&longitude=${c.lng.toFixed(3)}&start_date=${date}&end_date=${date}&hourly=cloudcover,precipitation,snowfall,wind_speed_10m,wind_direction_10m&timezone=auto`;
  try{
    const r=await fetch(url); const j=await r.json(); if(!j?.hourly?.time) return;
    const idx=j.hourly.time.findIndex(t=>t.endsWith(`T${String(hour).padStart(2,"0")}:00`)); const k=idx>=0?idx:12;
    cloudCover=j.hourly.cloudcover?.[k]??50;
    rainAmount=j.hourly.precipitation?.[k]??0;
    snowAmount=j.hourly.snowfall?.[k]??0;
    windSpeed=Math.max(.5,(j.hourly.wind_speed_10m?.[k]??2)/3); // pour drift (pas affichage direct)
    const windDirDeg=j.hourly.wind_direction_10m?.[k]??180; windAngle=(windDirDeg*Math.PI)/180;

    const ms=windSpeed*3, kmh=ms*3.6;
    document.getElementById("cloudVal").textContent=Math.round(cloudCover);
    document.getElementById("rainVal").textContent=rainAmount.toFixed(2);
    document.getElementById("windVal").textContent=ms.toFixed(1);
    document.getElementById("windKmh").textContent=kmh.toFixed(1);
    const ar=degToDirArrow(windDirDeg); document.getElementById("windDirTxt").textContent=`${ar.n} ${ar.c}`;

    // Alerts
    alertsState={ thunder:false,gale:false,storm:false,typhoon:false,snow:false };
    const alerts=[];
    if(rainAmount>=10){alerts.push("‚õàÔ∏è Thunderstorm"); alertsState.thunder=true;}
    else if(rainAmount>=3){alerts.push("üåßÔ∏è Heavy rain");}
    if(ms>=20){alerts.push("üí® Gale"); alertsState.gale=true;}
    if(cloudCover>=85 && rainAmount>=1 && ms>=12){alerts.push("üå©Ô∏è Storm"); alertsState.storm=true;}
    if(ms>=33){alerts.push("üåÄ Typhoon-like"); alertsState.typhoon=true;}
    if(snowAmount>=0.5){alerts.push("‚ùÑÔ∏è Snow"); alertsState.snow=true;}
    document.getElementById("alertsText").textContent=alerts.length?alerts.join(" ¬∑ "):"‚Äî";

    placeSunByHour(hour); sun.visible=true;
  }catch(e){console.warn(e);}finally{ if(spin) spin.style.display="none"; }
}
document.getElementById("load").onclick=()=>loadWeather(map.getCenter());

// ---------- Sun (draggable) ----------
function placeSunByHour(h){const W=canvas.width,H=canvas.height; if(h<10){sun.x=W*.8;sun.y=H*.8;} else if(h<16){sun.x=W*.5;sun.y=H*.2;} else {sun.x=W*.2;sun.y=H*.8;}}
addEventListener("pointerdown",e=>{if(!sun.visible)return; if(Math.hypot(e.clientX-sun.x,e.clientY-sun.y)<sun.size) draggingSun=true;});
addEventListener("pointermove",e=>{if(draggingSun){sun.x=e.clientX; sun.y=e.clientY;}});
addEventListener("pointerup",()=>draggingSun=false);

// ---------- Word sampling (fixed) ----------
function getWordPointsFixed(word,widthPx){
  const off=document.createElement("canvas"), c=off.getContext("2d");
  const offW=Math.round(widthPx), offH=Math.round(widthPx*0.42); off.width=offW; off.height=offH;
  let fontPx=Math.round(widthPx*0.3); c.font=`bold ${fontPx}px monospace`;
  let tw=c.measureText(word).width;
  if(tw>offW*0.92){fontPx=Math.max(12,Math.round(fontPx*(offW*0.92/tw))); c.font=`bold ${fontPx}px monospace`; tw=c.measureText(word).width;}
  c.fillStyle="#fff"; c.fillText(word,(offW-tw)/2,Math.round(offH*0.72));
  const img=c.getImageData(0,0,offW,offH).data; const step=Math.max(3,Math.round(offW/180));
  const pts=[]; for(let y=0;y<offH;y+=step){for(let x=0;x<offW;x+=step){const i=(y*offW+x)*4; if(img[i]>200) pts.push({x,y});}}
  return {pts,offW,offH,step};
}

// ---------- Regenerate (captures weather snapshot & log word) ----------
const BASE_POINT_PX = 24;
document.getElementById("regen").onclick=()=>{
  const word=(document.getElementById("word")?.value || "CLOUD").trim();
  if(word.length>0){ wordsHistory.push(word); } // log pour impression

  const {pts,offW,offH}=getWordPointsFixed(word || "CLOUD", FIXED_WORD_WIDTH);
  const anchorLL=map.getCenter(); const anchorCP=map.latLngToContainerPoint(anchorLL);
  const localWeather={ windAngle, windSpeed, rainAmount, cloudCover }; // snapshot conserv√©
  const group={ points:[], weather:localWeather, opacity:1, forming:true, anchorLL, baseW:offW, baseH:offH, basePointPx:BASE_POINT_PX, pointPx:BASE_POINT_PX };
  for(const p of pts){
    const px=p.x-offW/2, py=p.y-offH/2;
    const targetLL=map.containerPointToLatLng([anchorCP.x+px, anchorCP.y+py]);
    const base=clouds[Math.floor(Math.random()*clouds.length)];
    group.points.push({ lat:base.lat,lng:base.lng, px,py, targetLat:targetLL.lat,targetLng:targetLL.lng, alpha:.25, char:"‚óã", phase:Math.random()*Math.PI*2 });
  }
  wordClouds.push(group);
};

// ---------- Typhoon ----------
document.getElementById("typhoon").onclick=()=>{
  typhoonActive=true; typhoonUntil=performance.now()+4000;
  const a=document.getElementById("alertsText"); if(a) a.textContent="üåÄ Typhoon (simulated)";
  alertsState.typhoon=true;
};

// ---------- Warp weather (since 1940) ----------
document.getElementById("warp").onclick=()=>{
  const start=new Date('1940-01-01'), end=new Date(), d=randomDate(start,end);
  const yy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'), hh=String(Math.floor(Math.random()*24)).padStart(2,'0');
  document.getElementById('date').value=`${yy}-${mm}-${dd}`; document.getElementById('hour').value=`${hh}:00`;
  loadWeather(map.getCenter());
};

// ---------- PRINT (iframe cach√©, sans backticks/template string) ----------
document.getElementById("printBtn").onclick = function () {
  var text = (wordsHistory.length ? wordsHistory.join(" / ") : (document.getElementById("word").value || "„Éª„Éª„Éª"));
  var safe = escapeHtml(text);

  // Compose le HTML par concat√©nation classique
  var html = ""
    + "<!DOCTYPE html>\n"
    + "<html>\n"
    + "<head>\n"
    + '<meta charset="utf-8">\n'
    + "<title>Ecriture Meteo</title>\n"
    + "<style>\n"
    + "  @page { size: A4; margin: 12mm; }\n"
    + "  html, body { background: #fff; color: #666; font-family: monospace; }\n"
    + "  .page { width: 190mm; min-height: 273mm; margin: 0 auto; display:flex; align-items:center; justify-content:center; }\n"
    + "  .content { font-size: 14pt; line-height: 1.6; word-break: break-word; white-space: pre-wrap; text-align: center; max-width: 170mm; }\n"
    + "  h1 { font-size: 12pt; font-weight: 700; letter-spacing: .08em; color: #888; text-align:center; margin: 0 0 8mm 0; }\n"
    + "  .footer { position: fixed; bottom: 8mm; left: 0; right: 0; text-align: center; font-size: 9pt; color: #aaa; }\n"
    + "  @media print { .noprint{display:none;} body{margin:0;} }\n"
    + "</style>\n"
    + "</head>\n"
    + "<body>\n"
    + '  <div class="page">\n'
    + '    <div class="wrap">\n'
    + "      <h1>Ecriture Meteo</h1>\n"
    + '      <div class="content">' + safe + "</div>\n"
    + "    </div>\n"
    + "  </div>\n"
    + '  <div class="footer">Generated from Ecriture Meteo ‚Äî ' + escapeHtml(new Date().toLocaleString()) + "</div>\n"
    + "  <script>\n"
    + "    window.addEventListener('load', function(){ setTimeout(function(){ window.print(); }, 50); });\n"
    + "    window.addEventListener('afterprint', function(){ try { parent.postMessage({type:'PRINT_DONE'}, '*'); } catch(e){} });\n"
    + "  <\/script>\n"
    + "</body>\n"
    + "</html>";

  // Iframe cach√©
  var iframe = document.createElement("iframe");
  iframe.style.position = "fixed";
  iframe.style.right = "0";
  iframe.style.bottom = "0";
  iframe.style.width = "0";
  iframe.style.height = "0";
  iframe.style.border = "0";
  iframe.setAttribute("aria-hidden", "true");
  document.body.appendChild(iframe);

  // Nettoyage fiable (message + fallback timeout)
  function cleanup() { try { document.body.removeChild(iframe); } catch(e){} }
  function onMsg(ev){
    if (ev && ev.data && ev.data.type === "PRINT_DONE") {
      window.removeEventListener("message", onMsg);
      cleanup();
    }
  }
  window.addEventListener("message", onMsg);
  setTimeout(function(){ window.removeEventListener("message", onMsg); cleanup(); }, 8000);

  // Ecrit le HTML et d√©clenche l'impression
  iframe.onload = function(){
    try {
      var doc = iframe.contentWindow.document;
      doc.open();
      doc.write(html);
      doc.close();
    } catch(e) {
      // Fallback tr√®s rare: si doc.write √©choue, on tente srcdoc
      try { iframe.srcdoc = html; } catch(_) {}
    }
  };
  // Charge about:blank pour garantir l'√©v√©nement onload
  iframe.src = "about:blank";
};


// ---------- Draw loop ----------
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const now=performance.now(), t=now/1000;

  let tyPower=0;
  if(typhoonActive){
    typhoonUntil=Math.max(typhoonUntil,now);
    tyPower=Math.max(0,(typhoonUntil-now)/4000);
    if(typhoonActive && tyPower===0){
      typhoonActive=false; createClouds(); rainDrops=[]; lightningDrops=[]; snowFlakes=[]; wordClouds=[]; alertsState.typhoon=false;
    }
  }

  // Sun
  if(sun.visible){
    const stormy=rainAmount>2 || cloudCover>80; const pulse=stormy?(Math.sin(t*3)*0.2+1):1;
    ctx.font=String(sun.size)+"px monospace"; ctx.fillStyle="#ffcc66"; ctx.globalAlpha=pulse;
    ctx.shadowBlur=25; ctx.shadowColor="rgba(255,220,120,0.8)"; ctx.fillText("‚óè",sun.x,sun.y); ctx.shadowBlur=0;
  }

  const Z = motionZoomBoost(17);
  const galeBoost = alertsState.gale ? 1.4 : 1.0;
  const tremble   = (alertsState.typhoon || typhoonActive) ? 1.6 : 0;

  // background clouds
  const move = WIND_DRIFT_BASE*windSpeed*galeBoost*Z;
  ctx.font="20px monospace";
  for(const c of clouds){
    c.lat += Math.sin(windAngle)*move*(typhoonActive?(80*tyPower+1):1);
    c.lng += Math.cos(windAngle)*move*(typhoonActive?(80*tyPower+1):1);
    if(alertsState.snow && Math.random()<0.002*(0.5+snowAmount/2)){
      snowFlakes.push({lat:c.lat,lng:c.lng,yOffset:0,speed:1.1+snowAmount*0.5,wind:windAngle,char:"*"});
    }
    const pt=map.latLngToContainerPoint([c.lat,c.lng]);
    const jx=tremble?(Math.random()*tremble - tremble/2):0, jy=jx;
    ctx.globalAlpha=c.alpha*(typhoonActive?(1-0.7*(1-tyPower)):1);
    ctx.fillStyle="#fff"; ctx.fillText("‚óã",pt.x+jx,pt.y+jy);
  }

  // words ‚Äî float with their own snapshot
  for(const g of wordClouds){
    const wv=g.weather;
    g.pointPx=Math.round(g.basePointPx*WORD_SIZE_SCALE);
    ctx.font=String(Math.max(8,g.pointPx))+"px monospace";
    const anchorCP=map.latLngToContainerPoint(g.anchorLL);
    const wMove=WIND_DRIFT_BASE*wv.windSpeed*(alertsState.gale?1.7:1.0)*Z;

    for(const p of g.points){
      const targetCPx=anchorCP.x+p.px, targetCPy=anchorCP.y+p.py;
      const targetLL=map.containerPointToLatLng([targetCPx,targetCPy]);

      const k=g.forming?0.10:0.04;
      p.lat += (targetLL.lat - p.lat)*k;
      p.lng += (targetLL.lng - p.lng)*k;

      if(g.forming){ p.alpha=Math.min(1,p.alpha+0.02); if(p.alpha>0.7) p.char="‚óè"; }
      else if(typhoonActive){
        p.lat += Math.sin(wv.windAngle)*wMove*(90*tyPower+0.2);
        p.lng += Math.cos(wv.windAngle)*wMove*(90*tyPower+0.2);
        p.alpha=Math.max(0,p.alpha-0.015*(1-tyPower));
      }else{
        p.lat += Math.sin(wv.windAngle)*wMove*WIND_DRIFT_SCALE + Math.sin(t*BREATH_FREQ + p.phase)*BREATH_AMP;
        p.lng += Math.cos(wv.windAngle)*wMove*WIND_DRIFT_SCALE + Math.cos(t*BREATH_FREQ + p.phase)*BREATH_AMP;
        if(Math.random()<0.0003) p.alpha=Math.max(0,p.alpha-0.0008);
      }

      const pt=map.latLngToContainerPoint([p.lat,p.lng]);
      const jx=tremble?(Math.random()*tremble - tremble/2):0, jy=jx;
      const ch=(alertsState.typhoon||typhoonActive)?"‚óã":p.char;

      if(sun.visible){
        const dx=pt.x - sun.x, dy=pt.y - sun.y, dist=Math.max(1,Math.hypot(dx,dy));
        const offX=(dx/dist)*8, offY=(dy/dist)*8, shade=Math.max(0,1-dist/300);
        ctx.globalAlpha=p.alpha*0.45*shade; ctx.fillStyle="rgba(60,60,80,0.6)";
        ctx.fillText(ch,pt.x+offX+jx,pt.y+offY+jy);
      }
      ctx.globalAlpha=p.alpha; ctx.fillStyle="#fff"; ctx.fillText(ch,pt.x+jx,pt.y+jy);

      if(!typhoonActive && wv.rainAmount>0.1 && Math.random()<wv.rainAmount*0.0016){
        rainDrops.push({lat:p.lat,lng:p.lng,yOffset:0,speed:1.8+wv.rainAmount*2.8,wind:wv.windAngle,char:(Math.random()<0.5?":":";")});
      }
      if(!typhoonActive && alertsState.thunder && Math.random()<0.0045){
        lightningDrops.push({lat:p.lat,lng:p.lng,yOffset:0,speed:2.4+(wv.rainAmount*2.6),wind:wv.windAngle,char:(Math.random()<0.5?":":";")});
      }
      if(alertsState.snow && Math.random()<0.0015){
        snowFlakes.push({lat:p.lat,lng:p.lng,yOffset:0,speed:1.0+snowAmount*0.5,wind:wv.windAngle,char:"*"});
      }
    }
    if(g.forming && Math.random()<0.01) g.forming=false;
  }
  wordClouds = wordClouds.filter(g=>g.points.some(p=>p.alpha>0.02));

  // rain (blue)
  ctx.globalAlpha=0.85; ctx.fillStyle="#66ccff"; ctx.font="16px monospace";
  for(const d of rainDrops){
    const mul=typhoonActive?2.3:1;
    d.yOffset += d.speed*mul;
    d.lng += Math.cos(d.wind) * 0.00005 * (typhoonActive?3:1) * motionZoomBoost(17);
    const pt=map.latLngToContainerPoint([d.lat,d.lng]);
    ctx.fillText(d.char,pt.x,pt.y+d.yOffset);
  }
  rainDrops = rainDrops.filter(d=>d.yOffset<250);

  // thunder rain (yellow)
  ctx.globalAlpha=0.9; ctx.fillStyle="#ffd84d"; ctx.font="16px monospace";
  for(const d of lightningDrops){
    const mul=typhoonActive?2.6:1.2;
    d.yOffset += d.speed*mul;
    d.lng += Math.cos(d.wind) * 0.00006 * (typhoonActive?3:1) * motionZoomBoost(17);
    const pt=map.latLngToContainerPoint([d.lat,d.lng]);
    ctx.fillText(d.char,pt.x,pt.y+d.yOffset);
  }
  lightningDrops = lightningDrops.filter(d=>d.yOffset<250);

  // snow (white *)
  ctx.globalAlpha=0.95; ctx.fillStyle="#fff"; ctx.font="16px monospace";
  for(const s of snowFlakes){
    const mul=typhoonActive?1.6:1.0;
    s.yOffset += s.speed*mul*0.8;
    s.lng += Math.cos(s.wind) * 0.00003 * (typhoonActive?3:1) * motionZoomBoost(17);
    const pt=map.latLngToContainerPoint([s.lat,s.lng]);
    ctx.fillText(s.char,pt.x,pt.y+s.yOffset);
  }
  snowFlakes = snowFlakes.filter(s=>s.yOffset<260);

  requestAnimationFrame(draw);
}
draw();
</script>
</body>
</html>

